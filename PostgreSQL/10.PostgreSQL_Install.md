

# 1. Install 

## 1) Install with Helm

### (1) install

```sh

$ helm search repo postgresql
NAME                    CHART VERSION   APP VERSION     DESCRIPTION
bitnami/postgresql      15.5.1          16.3.0          PostgreSQL (Postgres) is an open source object-...
bitnami/postgresql-ha   14.1.3          16.3.0          This PostgreSQL cluster solution includes the P...
bitnami/supabase        5.2.0           1.24.4          Supabase is an open source Firebase alternative...

# 2026.02.22
NAME                    CHART VERSION   APP VERSION     DESCRIPTION
bitnami/postgresql      18.4.0          18.2.0          PostgreSQL (Postgres) is an open source object-...
bitnami/postgresql-ha   16.3.2          17.6.0          This PostgreSQL cluster solution includes the P...
bitnami/cloudnative-pg  1.0.11          1.26.1          CloudNativePG is an open-source tool for managi...
bitnami/supabase        5.3.6           1.24.7          DEPRECATED Supabase is an open source Firebase ...
runix/pgadmin4          1.59.0          9.11            pgAdmin4 is a web based administration tool for...
bitnami/minio-operator  0.2.9           7.1.1           MinIO(R) Operator is a Kubernetes-native tool f...



# namespace 생성
$ kubectl create ns cpapa3

# Helm install
$ helm -n cpapa3 install my-postgres bitnami/postgresql \
    --set global.postgresql.auth.postgresPassword=New1234! \
    --set global.postgresql.auth.username=cpapa \
    --set global.postgresql.auth.password=Prd1234! \
    --set global.postgresql.auth.database=cpapa \
    --dry-run=true

NAME: mypost
LAST DEPLOYED: Sun Jun  2 13:25:17 2024
NAMESPACE: postgressql
STATUS: deployed
REVISION: 1
TEST SUITE: None
NOTES:
CHART NAME: postgresql
CHART VERSION: 15.5.1
APP VERSION: 16.3.0


# 확인
$ helm -n cpapa3 ls
NAME            NAMESPACE       REVISION        UPDATED                                 STATUS          CHART                   APP VERSION
my-postgres     cpapa3-dev      1               2026-02-19 14:46:01.033264078 +0000 UTC deployed        postgresql-18.4.0       18.2.0
my-postgres     cpapa3          1               2026-02-22 05:26:08.164122579 +0000 UTC deployed        postgresql-18.4.0       18.2.0


# 삭제시...
$ helm -n postgressql delete mypost

```



### (2) 확인

```sh

$ kubectl -n cpapa3 get all

NAME                           READY   STATUS    RESTARTS   AGE
pod/my-postgres-postgresql-0   1/1     Running   0          37s

NAME                                TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)    AGE
service/my-postgres-postgresql      ClusterIP   10.43.17.17   <none>        5432/TCP   37s
service/my-postgres-postgresql-hl   ClusterIP   None          <none>        5432/TCP   37s

NAME                                      READY   AGE
statefulset.apps/my-postgres-postgresql   1/1     37s


```





## 2) Install with Docker

### (1) Install

```sh

$ docker search bitnami/postgresql
NAME                                DESCRIPTION                                  STARS     OFFICIAL
bitnami/postgresql                  Bitnami Secure Image for postgresql          374


# https://hub.docker.com/r/bitnami/postgresql/tags

$ docker manifest inspect bitnami/postgresql:latest

$ docker pull bitnami/postgresql:latest


$ docker run -d \
  --name my-postgres \
  -e POSTGRESQL_POSTGRES_PASSWORD=New1234! \
  -e POSTGRESQL_USERNAME=cpapa \
  -e POSTGRESQL_PASSWORD=Dev1234! \
  -e POSTGRESQL_DATABASE=cpapa-dev \
  -p 5432:5432 \
  bitnami/postgresql:latest




# 확인
$ docker ps 
CONTAINER ID   IMAGE                       COMMAND                  CREATED         STATUS         PORTS                    NAMES
190976bf7c2b   bitnami/postgresql:latest   "/opt/bitnami/script…"   5 seconds ago   Up 5 seconds   0.0.0.0:5432->5432/tcp   my-postgres


# 삭제시...
$ docker rm -f my-postgres


```



### (2) Container 로 진입

```sh

# 일반유저(1001) 로 진입
$ docker exec -it my-postgres bash

# root 로 진입
$ docker exec -it --user root my-postgres bash


```



# 2. postgesql CLI



```sh

# 예시
$ psql -h <호스트> -U <사용자> -d <데이터베이스명>


$ psql -h my-postgres-postgresql -U cpapa -d cpapa


$ PGPASSWORD=Prd1234! psql -h my-postgres-postgresql.cpapa3.svc -U cpapa -d cpapa





\l
\c dbname
\dt
\d table
\d+ table
\du
\x
\timing
SELECT * FROM table LIMIT 10;
\q


```





# 3. Client psql



```sh

$ kubectl -n pgadmin create deploy psql-client \
  --image=postgres:16 \
  -- sleep 365d


# 접속
$ kubectl -n pgadmin exec -it deploy/psql-client -- bash

```









# 4. 백업/복구

> 롤/권한 포함



## 1) 백업

pg_dump (※ 슈퍼유저 권한 필요)

```sh
# 백업 파일 경로(항상 이 파일로 덮어쓰기)
BACKUP_DIR=/var/backups/postgresql
BACKUP_FILE=$BACKUP_DIR/backup_$(date +%Y%m%d_%H%M%S).sql

# 확인
$ echo $DATABASE_URL
postgresql://postgres:password@helium/heliumdb?sslmode=disable


$ mkdir -p "$BACKUP_DIR"

# 안전하게: 임시파일에 먼저 만든 뒤, 성공하면 원본을 교체(atomic overwrite)
$ pg_dump "$DATABASE_URL" --no-owner --no-privileges \
    -F p -f "${BACKUP_FILE}.tmp" \
  && mv -f "${BACKUP_FILE}.tmp" "${BACKUP_FILE}"


```



## 2) 복구

```sh

$ mkdir ~/song
  cd ~/song
  
$ cat > backup_20260219_075639.sql
...



# 예시
$ psql -h <호스트> -U <사용자> -d <데이터베이스명> -f backup_20260219_075639.sql


# 복구
$ psql -h 172.30.1.31 -p 5432 -U cpapa -d cpapa-dev -f backup_20260219_075639.sql


$ psql -h localhost -p 5432 -U cpapa -d cpapa-dev -f backup_20260219_075639.sql


$ psql -h my-postgres-postgresql.cpapa3.svc -U cpapa -d cpapa -f backup_20260219_075639.sql



```



