



# 1.개요

**k3s + Traefik Ingress Controller 환경에서 Gateway API를 사용해 PostgreSQL을 TCP로 노출**하는 테스트한다.



## 흐름

```
외부 → Gateway API → Traefik → PostgreSQL (TCP 5432)
```



## 아키텍처 구조

```
Client
   ↓
[ Gateway (TCP 5432) ]
   ↓
Traefik
   ↓
Service (ClusterIP)
   ↓
Postgres Pod
```





# 2. Gateway API CRD 설치



k3s에는 기본 포함되어 있지 않다.

```sh

# 1. standard 설치
$ kubectl apply -f https://github.com/kubernetes-sigs/gateway-api/releases/latest/download/standard-install.yaml

# 확인
$ kubectl get crd | grep gateway

gatewayclasses.gateway.networking.k8s.io                          2025-12-25T10:20:41Z
gateways.gateway.networking.k8s.io                                2025-12-25T10:20:41Z
grpcroutes.gateway.networking.k8s.io                              2025-12-25T10:20:41Z
httproutes.gateway.networking.k8s.io                              2025-12-25T10:20:41Z
referencegrants.gateway.networking.k8s.io                         2025-12-25T10:20:41Z



# 2. experimental
$ kubectl apply -f https://github.com/kubernetes-sigs/gateway-api/releases/latest/download/experimental-install.yaml

customresourcedefinition.apiextensions.k8s.io/backendtlspolicies.gateway.networking.k8s.io created
Warning: resource customresourcedefinitions/gatewayclasses.gateway.networking.k8s.io is missing the kubectl.kubernetes.io/last-applied-configuration annotation which is required by kubectl apply. kubectl apply should only be used on resources created declaratively by either kubectl create --save-config or kubectl apply. The missing annotation will be patched automatically.
customresourcedefinition.apiextensions.k8s.io/gatewayclasses.gateway.networking.k8s.io configured
Warning: resource customresourcedefinitions/gateways.gateway.networking.k8s.io is missing the kubectl.kubernetes.io/last-applied-configuration annotation which is required by kubectl apply. kubectl apply should only be used on resources created declaratively by either kubectl create --save-config or kubectl apply. The missing annotation will be patched automatically.
customresourcedefinition.apiextensions.k8s.io/gateways.gateway.networking.k8s.io configured
Warning: resource customresourcedefinitions/grpcroutes.gateway.networking.k8s.io is missing the kubectl.kubernetes.io/last-applied-configuration annotation which is required by kubectl apply. kubectl apply should only be used on resources created declaratively by either kubectl create --save-config or kubectl apply. The missing annotation will be patched automatically.
customresourcedefinition.apiextensions.k8s.io/grpcroutes.gateway.networking.k8s.io configured
Warning: resource customresourcedefinitions/httproutes.gateway.networking.k8s.io is missing the kubectl.kubernetes.io/last-applied-configuration annotation which is required by kubectl apply. kubectl apply should only be used on resources created declaratively by either kubectl create --save-config or kubectl apply. The missing annotation will be patched automatically.
Warning: resource customresourcedefinitions/referencegrants.gateway.networking.k8s.io is missing the kubectl.kubernetes.io/last-applied-configuration annotation which is required by kubectl apply. kubectl apply should only be used on resources created declaratively by either kubectl create --save-config or kubectl apply. The missing annotation will be patched automatically.
customresourcedefinition.apiextensions.k8s.io/referencegrants.gateway.networking.k8s.io configured
customresourcedefinition.apiextensions.k8s.io/tcproutes.gateway.networking.k8s.io created
customresourcedefinition.apiextensions.k8s.io/tlsroutes.gateway.networking.k8s.io created
customresourcedefinition.apiextensions.k8s.io/udproutes.gateway.networking.k8s.io created
customresourcedefinition.apiextensions.k8s.io/xbackendtrafficpolicies.gateway.networking.x-k8s.io created
customresourcedefinition.apiextensions.k8s.io/xlistenersets.gateway.networking.x-k8s.io created
customresourcedefinition.apiextensions.k8s.io/xmeshes.gateway.networking.x-k8s.io created
The CustomResourceDefinition "httproutes.gateway.networking.k8s.io" is invalid: metadata.annotations: Too long: may not be more than 262144 bytes

# 확인
$ kubectl get crd | grep gateway
backendtlspolicies.gateway.networking.k8s.io                      2026-02-19T10:30:06Z
gatewayclasses.gateway.networking.k8s.io                          2025-12-25T10:20:41Z
gateways.gateway.networking.k8s.io                                2025-12-25T10:20:41Z
grpcroutes.gateway.networking.k8s.io                              2025-12-25T10:20:41Z
httproutes.gateway.networking.k8s.io                              2025-12-25T10:20:41Z
referencegrants.gateway.networking.k8s.io                         2025-12-25T10:20:41Z
tcproutes.gateway.networking.k8s.io                               2026-02-19T10:30:07Z
tlsroutes.gateway.networking.k8s.io                               2026-02-19T10:30:07Z
udproutes.gateway.networking.k8s.io                               2026-02-19T10:30:07Z
xbackendtrafficpolicies.gateway.networking.x-k8s.io               2026-02-19T10:30:07Z
xlistenersets.gateway.networking.x-k8s.io                         2026-02-19T10:30:08Z
xmeshes.gateway.networking.x-k8s.io                               2026-02-19T10:30:08Z


```





# 3. Traefik 설정



## 1) traefik version 확인

k3s 기본 Traefik 버전이 2.9 이상이면 Gateway API TCP 지원 가능



확인:

```sh
$ kubectl -n kube-system get pods | grep traefik

```

버전 확인:

```sh
$ kubectl -n kube-system describe deployment traefik
...
  Containers:
   traefik:
    Image:       rancher/mirrored-library-traefik:3.5.1

```



## 2) Gateway API provider가 활성화

만약 Gateway API provider가 활성화되어 있지 않다면 Helm values 수정이 필요하다.



k3s는 Traefik을 보통 HelmChart CR로 관리합니다. 그래서 **Deployment를 직접 edit하면 다시 덮어써질 수 있다.**

HelmChart의 values를 패치한다.



### (1) Helmchart 확인

k3s 기본 Traefik은 HelmChart 리소스로 관리된다.

```sh

# 확인
$ kubectl -n kube-system get helmchart traefik -o yaml

```

valuesContent에 아래 추가 필요:

```sh

# 반영전
spec:
  ...
  valuesContent: |-
  ...
    providers:
      kubernetesIngress:
        publishedService:
          enabled: true

# 반영후
spec:
  ...
  valuesContent: |-
  ...
    providers:
      kubernetesIngress:
        publishedService:
          enabled: true
      kubernetesGateway:     # <-- 추가
  
```



or

```sh

$ helm -n kube-system get values traefik -a
...
providers:
  file:
    content: ""
    enabled: false
    watch: true
  kubernetesCRD:
    allowCrossNamespace: false
    allowEmptyServices: true
    allowExternalNameServices: false
    enabled: true
    ingressClass: ""
    namespaces: []
    nativeLBByDefault: false
  kubernetesGateway:
    enabled: false
    experimentalChannel: false
    labelselector: ""
    namespaces: []
    nativeLBByDefault: false
    statusAddress:
      hostname: ""
      ip: ""
      service:
        enabled: true
        name: ""
        namespace: ""
  kubernetesIngress:
    allowEmptyServices: true
    allowExternalNameServices: false
    enabled: true
    ingressClass: null
    namespaces: []
    nativeLBByDefault: false
    publishedService:
      enabled: true
      pathOverride: ""
    strictPrefixMatching: false
...

```









### (2) 반영

```sh


$ helm -n kube-system ls
NAME            NAMESPACE       REVISION        UPDATED                                 STATUS          CHART                           APP VERSION
traefik         kube-system     2               2026-02-19 09:48:01.899871637 +0000 UTC deployed        traefik-37.1.1+up37.1.0         v3.5.1
traefik-crd     kube-system     1               2025-12-25 10:20:40.471652322 +0000 UTC deployed        traefik-crd-37.1.1+up37.1.0     v3.5.1



$ kubectl -n kube-system get helmchart traefik
NAME          REPO   CHART                                                                      VERSION   TARGETNAMESPACE   BOOTSTRAP   FAILED
traefik              https://%{KUBERNETES_API}%/static/charts/traefik-37.1.1+up37.1.0.tgz                                               False
traefik-crd          https://%{KUBERNETES_API}%/static/charts/traefik-crd-37.1.1+up37.1.0.tgz                                           False



$ cat <<'EOF' | kubectl apply -f -
apiVersion: helm.cattle.io/v1
kind: HelmChartConfig
metadata:
  name: traefik
  namespace: kube-system
spec:
  valuesContent: |-
    providers:
      kubernetesIngress:
        publishedService:
          enabled: true
      kubernetesGateway:
        enabled: true
EOF



```



### (3) 확인

```sh

$ kubectl -n kube-system get deploy traefik -o jsonpath='{.spec.template.spec.containers[0].args}' | tr ' ' '\n' | grep -i kubernetesgateway
["--entryPoints.metrics.address=:9100/tcp","--entryPoints.traefik.address=:8080/tcp","--entryPoints.web.address=:8000/tcp","--entryPoints.websecure.address=:8443/tcp","--api.dashboard=true","--ping=true","--metrics.prometheus=true","--metrics.prometheus.entrypoint=metrics","--providers.kubernetescrd","--providers.kubernetescrd.allowEmptyServices=true","--providers.kubernetesingress","--providers.kubernetesingress.allowEmptyServices=true","--providers.kubernetesingress.ingressendpoint.publishedservice=kube-system/traefik","--providers.kubernetesgateway","--providers.kubernetesgateway.statusaddress.service.name=traefik","--providers.kubernetesgateway.statusaddress.service.namespace=kube-system","--entryPoints.websecure.http.tls=true","--log.level=INFO"]


```

GatewayClass가 생겼는지

```sh

$ kubectl get gatewayclass

NAME      CONTROLLER                      ACCEPTED   AGE
traefik   traefik.io/gateway-controller   True       50s


```



로그로 확인

```sh

$ kubectl -n kube-system logs deploy/traefik | grep -i kubernetesgateway

2026-02-19T10:12:06Z INF Label selector is: "" providerName=kubernetesgateway
2026-02-19T10:12:06Z INF Creating in-cluster Provider client endpoint= providerName=kubernetesgateway


```





# 4. PostgreSQL 배포



## 1) helm 방식으로 설치



K8s 안에 PostgreSQL을 설치

```sh

$ helm repo add bitnami https://charts.bitnami.com/bitnami
  helm repo update

$ helm search repo postgres
NAME                    CHART VERSION   APP VERSION     DESCRIPTION
bitnami/postgresql      18.4.0          18.2.0          PostgreSQL (Postgres) is an open source object-...
bitnami/postgresql-ha   16.3.2          17.6.0          This PostgreSQL cluster solution includes the P...
bitnami/cloudnative-pg  1.0.11          1.26.1          CloudNativePG is an open-source tool for managi...
bitnami/supabase        5.3.6           1.24.7          DEPRECATED Supabase is an open source Firebase ...
bitnami/minio-operator  0.2.9           7.1.1           MinIO(R) Operator is a Kubernetes-native tool f...



$ kubectl create ns cpapa3-dev 

# PostgreSQL 설치
$ helm -n cpapa3-dev install my-postgres bitnami/postgresql \
  --set auth.username=cpapa \
  --set auth.password=Dev1***! \
  --set auth.database=cpapa-dev \
  --set primary.service.ports.postgresql=5432


# 확인
$ helm -n cpapa3-dev ls
NAME            NAMESPACE       REVISION        UPDATED                                 STATUS          CHART                   APP VERSION
my-postgres     cpapa3-dev      1               2026-02-19 10:21:17.188843938 +0000 UTC deployed        postgresql-18.4.0       18.2.0

# 삭제시...
$ helm -n cpapa3-dev delete my-postgres


```



확인

```sh

$ kubectl -n cpapa3-dev get svc -l app.kubernetes.io/name=postgresql
NAME                        TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)    AGE
my-postgres-postgresql      ClusterIP   10.43.25.121   <none>        5432/TCP   8s
my-postgres-postgresql-hl   ClusterIP   None           <none>        5432/TCP   8s


```







## 2) (or) deployment 로 설치

간단한 테스트용으로:

```
apiVersion: apps/v1
kind: Deployment
metadata:
  name: postgres
  namespace: default
spec:
  replicas: 1
  selector:
    matchLabels:
      app: postgres
  template:
    metadata:
      labels:
        app: postgres
    spec:
      containers:
        - name: postgres
          image: postgres:16
          env:
            - name: POSTGRES_PASSWORD
              value: example
          ports:
            - containerPort: 5432
---
apiVersion: v1
kind: Service
metadata:
  name: postgres
spec:
  selector:
    app: postgres
  ports:
    - port: 5432
      targetPort: 5432
```

적용:

```
kubectl apply -f postgres.yaml
```







# 5. Gateway 설정

## 1) traefik 설정

* experimentalChannel 설정
  * additionalArguments로 experimentalChannel 강제 ON
* entryPoints 설정

```sh


cat <<'EOF' | kubectl apply -f -
apiVersion: helm.cattle.io/v1
kind: HelmChartConfig
metadata:
  name: traefik
  namespace: kube-system
spec:
  valuesContent: |-
    additionalArguments:
      - "--providers.kubernetesgateway=true"
      - "--providers.kubernetesgateway.experimentalchannel=true"
      - "--providers.kubernetesgateway.statusaddress.service.name=traefik"
      - "--providers.kubernetesgateway.statusaddress.service.namespace=kube-system"
      - "--entryPoints.postgres.address=:5432/tcp"

    ports:
      postgres:
        port: 5432
        expose:
          default: true
        exposedPort: 5432
        protocol: TCP

    providers:
      kubernetesIngress:
        publishedService:
          enabled: true
EOF


```





## 2) Gateway 생성 (TCP 리스너 설정)



```sh

$ cat << EOF | kubectl -n cpapa3-dev apply -f -
apiVersion: gateway.networking.k8s.io/v1
kind: Gateway
metadata:
  name: postgres-gateway
spec:
  gatewayClassName: traefik
  listeners:
    - name: postgres
      protocol: TCP
      port: 5432
EOF

```

확인:

```sh

$ kubectl -n cpapa3-dev get gateway
NAME               CLASS     ADDRESS       PROGRAMMED   AGE
postgres-gateway   traefik   172.30.1.31                21s


$ kubectl -n cpapa3-dev get gateway postgres-gateway -o yaml
apiVersion: gateway.networking.k8s.io/v1
kind: Gateway
metadata:
  ...
  generation: 1
  name: postgres-gateway
  namespace: cpapa3-dev
  ...
spec:
...
status:
  addresses:
  - type: IPAddress
    value: 172.30.1.31
  - type: IPAddress
    value: 172.30.1.32
  - type: IPAddress
    value: 172.30.1.33
  conditions:
  - lastTransitionTime: "2026-02-19T11:12:09Z"
    message: Gateway successfully scheduled
    observedGeneration: 1
    reason: Accepted
    status: "True"
    type: Accepted
  - lastTransitionTime: "2026-02-19T11:12:09Z"
    message: Gateway successfully scheduled
    observedGeneration: 1
    reason: Programmed
    status: "True"
    type: Programmed
  listeners:
  - attachedRoutes: 1
    conditions:
    - lastTransitionTime: "2026-02-19T11:12:09Z"
      message: No error found
      observedGeneration: 1
      reason: Accepted
      status: "True"
      type: Accepted
    - lastTransitionTime: "2026-02-19T11:12:09Z"
      message: No error found
      observedGeneration: 1
      reason: ResolvedRefs
      status: "True"
      type: ResolvedRefs
    - lastTransitionTime: "2026-02-19T11:12:09Z"
      message: No error found
      observedGeneration: 1
      reason: Programmed
      status: "True"
      type: Programmed
    name: postgres
    supportedKinds:
    - group: gateway.networking.k8s.io
      kind: TCPRoute


```





## 3) TCPRoute 생성



```sh

$ cat <<EOF | kubectl -n cpapa3-dev apply -f -
apiVersion: gateway.networking.k8s.io/v1alpha2
kind: TCPRoute
metadata:
  name: postgres-route
  namespace: cpapa3-dev
spec:
  parentRefs:
    - name: postgres-gateway
  rules:
    - backendRefs:
        - name: my-postgres-postgresql
          port: 5432
EOF

```

확인

```sh

$ kubectl -n cpapa3-dev get TCPRoute
NAME             AGE
postgres-route   6s


```



## 4) 외부 IP 확인



```sh

$ kubectl get svc -n kube-system
NAME             TYPE           CLUSTER-IP      EXTERNAL-IP                           PORT(S)                      AGE
kube-dns         ClusterIP      10.43.0.10      <none>                                53/UDP,53/TCP,9153/TCP       56d
metrics-server   ClusterIP      10.43.226.109   <none>                                443/TCP                      56d
traefik          LoadBalancer   10.43.105.228   172.30.1.31,172.30.1.32,172.30.1.33   80:31178/TCP,443:32183/TCP   56d

```

Traefik 서비스의 EXTERNAL-IP 확인.





# 6. 접속 테스트



### (1) pod로 실행

```sh

$ kubectl -n cpapa3-dev create deploy psql-client \
  --image=postgres:16 \
  -- sleep 365d

# pod내에서...
$ psql -h 172.30.1.31 -p 5432 -U cpapa -d cpapa-dev
psql: error: connection to server at "172.30.1.31", port 5432 failed: Connection refused
        Is the server running on that host and accepting TCP/IP connections?



$ psql -h a.ssongman.com -p 5432 -U cpapa -d cpapa-dev



# pod에서 Gateway/Traefik을 거치지 말고, 서비스로 바로 붙이기

$ psql -h my-postgres-postgresql.cpapa3-dev.svc.cluster.local -p 5432 -U cpapa -d cpapa-dev





```





```

psql -h 172.30.1.31 -p 5432 -U cpapa

ns: cpapa3-dev,  db:cpapa-dev
cpapa / Dev1***!



```



### (2) Docker로 실행

```sh
$ docker run -it --rm postgres:16 psql \
  -h 172.30.1.31 -p 5432 -U cpapa -d cpapa-dev

Password for user testuser:
psql (16.10 (Debian 16.10-1.pgdg13+1), server 17.6)
WARNING: psql major version 16, server major version 17.
         Some psql features might not work.
Type "help" for help.

testdb=>



```







# 7. 기타

## 만약 Gateway가 생성되지 않으면



```sh
kubectl get gatewayclass

$ kubectl get gatewayclass
NAME      CONTROLLER                      ACCEPTED   AGE
traefik   traefik.io/gateway-controller   True       23m


# 없을때...
$ cat <<'EOF' | kubectl apply -f -
apiVersion: gateway.networking.k8s.io/v1
kind: GatewayClass
metadata:
  name: traefik
spec:
  controllerName: traefik.io/gateway-controller
EOF


```



