# Ingress Controller





[[_TOC_]]



# 1. 개요

AKS 에 Nginx Ingress Controller 를 생성한다.



# 2. Ingress Controller



[참고] 아래 azure  가이드 참고

https://learn.microsoft.com/ko-kr/azure/aks/ingress-basic?tabs=azure-cli



## 1) Ingress Controller 설치(with helm)



```sh
$ kubectl create ns ingress-nginx


$ helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
  helm repo update


# [참고] default values 확인
#$ mkdir ~/temp/ingress-nginx
#  cd    ~/temp/ingress-nginx
#$ helm show values ingress-nginx/ingress-nginx > values.yaml



$ helm -n ingress-nginx install ingress-nginx ingress-nginx/ingress-nginx \
    --set controller.service.annotations."service\.beta\.kubernetes\.io/azure-load-balancer-health-probe-request-path"=/healthz



#[참고] 아래는 참고항목이다.
    --set controller.replicaCount=2 \
    --set controller.nodeSelector."kubernetes\.io/os"=linux \
    --set controller.nodeSelector.nodepool=infra \
    --set defaultBackend.nodeSelector."kubernetes\.io/os"=linux \
    --set controller.service.externalTrafficPolicy=Local


# ingress pod 확인
$ kubectl -n ingress-nginx get services -o wide -w ingress-nginx-controller
NAME                       TYPE           CLUSTER-IP        EXTERNAL-IP     PORT(S)                      AGE   SELECTOR
ingress-nginx-controller   LoadBalancer   192.168.126.196   20.249.203.31   80:31139/TCP,443:30459/TCP   34s   app.kubernetes.io/component=controller,app.kubernetes.io/instance=ingress-nginx,app.kubernetes.io/name=ingress-nginx


# Check Installed chart (release)
$ helm -n ingress-nginx ls

NAME            NAMESPACE       REVISION        UPDATED                                 STATUS          CHART                   APP VERSION
ingress-nginx   ingress-nginx   1               2024-10-01 19:41:23.264463 +0900 KST    deployed        ingress-nginx-4.11.2    1.11.2


# 사용자가 정의한 values 확인 **
$ helm -n ingress-nginx get values ingress-nginx
USER-SUPPLIED VALUES:
controller:
  service:
    annotations:
      service.beta.kubernetes.io/azure-load-balancer-health-probe-request-path: /healthz

```

* ingress svc 가 loadbalancer type 으로 생성되므로 부하분산장치와 공인IP node port 가 모두 생성된다.



Helm upgrade 시

```sh
# Upgrade 전
$ helm -n ingress-nginx ls
NAME            NAMESPACE       REVISION        UPDATED                                 STATUS          CHART                   APP VERSION
ingress-nginx   ingress-nginx   3               2024-09-24 14:06:14.67422 +0900 KST     deployed        ingress-nginx-4.11.2    1.11.2


helm -n ingress-nginx upgrade ingress-nginx ingress-nginx/ingress-nginx \
    --set controller.service.annotations."service\.beta\.kubernetes\.io/azure-load-balancer-health-probe-request-path"=/healthz \

    

# Upgrade 후
$ helm -n ingress-nginx ls
NAME            NAMESPACE       REVISION        UPDATED                                 STATUS          CHART                   APP VERSION
ingress-nginx   ingress-nginx   4               2024-09-27 11:27:08.318255 +0900 KST    deployed        ingress-nginx-4.11.2    1.11.2

```



## 2) 정보확인

Azure Portal에서 생성된 Load Balancer 를 메뉴를 보면 아래와 같은 정보를 확인할 수 있다.

* 메뉴 : Portal > Load Balacner > kubernetes 
  * FrontEnd IP Config
    * 외부접근 IP
      * 20.249.203.31
    
  * backend pool
  * 분산규칙 확인





# 3. Sample App(userlist) 배포



## 1) Namespace

```sh

# 1) ns
$ kubectl create ns temp

```



## 2) Deploy

```sh
# 2) deploy
$ cat <<EOF | kubectl -n temp apply -f -
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: userlist
    app.kubernetes.io/instance: userlist
  name: userlist
spec:
  replicas: 2
  selector:
    matchLabels:
      app: userlist
  template:
    metadata:
      labels:
        app: userlist
    spec:
      #nodeSelector:
      #  nodepool: app
      containers:
      - image: docker.io/ssongman/userlist:v1
        name: userlist
        ports:
        - containerPort: 8181
          protocol: TCP
      terminationGracePeriodSeconds: 30
EOF


```



## 3) Service

```sh
# 3) service
$ cat <<EOF | kubectl -n temp apply -f -
apiVersion: v1
kind: Service
metadata:
  name: userlist-svc
spec:
  type: ClusterIP
  ports:
  - port: 80
    targetPort: 8181
  selector:
    app: userlist
EOF

```



## 4) Ingress 

```sh
# ingress
$ cat <<EOF | kubectl -n temp apply -f -
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: userlist-ingress
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
spec:
  ingressClassName: nginx
  rules:
  - host: "userlist.20.249.203.31.nip.io"
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: userlist-svc
            port:
              number: 80
EOF

```



## 5) Clean Up

```sh
# 개별 리소스 삭제
$ kubectl -n temp delete deploy userlist
$ kubectl -n temp delete svc userlist-svc
$ kubectl -n temp delete ingress userlist-ingress

# Namespace 삭제 (NS내 모든 리스소가 삭제됨)
$ kubectl delete ns temp

```







