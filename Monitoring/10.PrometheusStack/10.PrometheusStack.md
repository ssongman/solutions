# Grafana + Prometheus + Alertmanager ì„¤ì¹˜ ê°€ì´ë“œ





# 1. ê°œìš”



AKS(Kubernetes) í™˜ê²½ì— kube-prometheus-stack(Grafana + Prometheus + Alertmanager) ì„ Helm Chartë¡œ ì„¤ì¹˜í•œë‹¤.



## 1) ëª¨ë‹ˆí„°ë§ ë° ì•Œë¦¼ ì‹œìŠ¤í…œ êµ¬ì¡°

AP ì— ë¶€í•˜ ë°œìƒì‹œ Alertmanager ì—ì„œ Mattermost ë¡œ ì•Œë¦¼ì„ ë°œì†¡í•œë‹¤.

### Prometheus + Alertmanager + Mattermost ì—°ë™ êµ¬ì„±

```mermaid
graph TD
    A[AP_] -->|Metrics Export__| B[Prometheus_]
    B --> C[Alertmanager_]
    C -->|Webhook| D[Mattermost_]
    B --> E[Grafna_]
    F[AKS Cluster_] --> B
    F --> C
    F --> E
```

*	AP(Application) ë¶€í•˜ ìƒíƒœ(Pod CPU/ë©”ëª¨ë¦¬/ì—ëŸ¬ìœ¨ ë“±)ë¥¼ ê°ì§€
*	Prometheus â†’ Alertmanager ê²½ìœ  â†’ Mattermost ì±„ë„ì— ê²½ê³  ë©”ì‹œì§€ ì „ì†¡



# 2. Install with Helm



## 1) helm ì¤€ë¹„

```sh
$ helm repo add prometheus-community https://prometheus-community.github.io/helm-charts

$ helm repo update

$ helm search repo kube-prometheus-stack
NAME                                            CHART VERSION   APP VERSION     DESCRIPTION
prometheus-community/kube-prometheus-stack      71.1.0          v0.82.0         kube-prometheus-stack collects Kubernetes manif...


# values.yaml í™•ì¸
$ helm show values prometheus-community/kube-prometheus-stack > 11.values.yaml


```





## 2) helm Install

### NS ìƒì„±

```sh
$ kubectl create ns monitoring

```



### (2) ì„¤ì¹˜ ëª…ë ¹

#### prom-stack-values.yaml ì¤€ë¹„

```sh

$ mkdir -p ~/song/prom-stack
  cd ~/song/prom-stack

$ cat > prom-stack-values.yaml

```



```yaml
grafana:
  enabled: true
  persistence:
    enabled: true
    size: 10Gi
  ingress:
    enabled: true
    ingressClassName: nginx
    hosts:
      - grafana.cbiz.kubepia.net
    annotations:
      cert-manager.io/cluster-issuer: letsencrypt-prod
      nginx.ingress.kubernetes.io/ssl-redirect: "true"
    tls:
      - secretName: grafana-tls
        hosts:
          - grafana.cbiz.kubepia.net

prometheus:
  ingress:
    enabled: true
    ingressClassName: nginx
    hosts:
      - prometheus.cbiz.kubepia.net
    annotations:
      cert-manager.io/cluster-issuer: letsencrypt-prod
      nginx.ingress.kubernetes.io/ssl-redirect: "true"
    tls:
      - secretName: prometheus-tls
        hosts:
          - prometheus.cbiz.kubepia.net
  persistence:
    enabled: true
    size: 20Gi

alertmanager:
  enabled: true
  ingress:
    enabled: true
    ingressClassName: nginx
    hosts:
      - alertmanager.cbiz.kubepia.net
    annotations:
      cert-manager.io/cluster-issuer: letsencrypt-prod
      nginx.ingress.kubernetes.io/ssl-redirect: "true"
    tls:
      - secretName: alertmanager-tls
        hosts:
          - alertmanager.cbiz.kubepia.net
  persistence:
    enabled: true
    size: 10Gi
```



#### helm install

```sh
$ cd ~/song/prom-stack

$ helm -n monitoring upgrade --install prom-stack prometheus-community/kube-prometheus-stack \
    -f prom-stack-values.yaml


# dry-run
$ helm -n monitoring upgrade --install prom-stack prometheus-community/kube-prometheus-stack \
    -f prom-stack-values.yaml \
    --dry-run=true > dry-run.yaml



Visit https://github.com/prometheus-operator/kube-prometheus for instructions on how to create & configure Alertmanager and Prometheus instances using the Operator.


# í™•ì¸
$ helm -n monitoring ls
NAME            NAMESPACE       REVISION        UPDATED                                 STATUS          CHART                           APP VERSION
prom-stack      monitoring      1               2025-05-02 18:08:14.468729 +0900 KST    deployed        kube-prometheus-stack-71.1.0    v0.82.0
prom-stack      monitoring      3               2025-05-02 22:48:03.285607 +0900 KST    deployed        kube-prometheus-stack-71.1.0    v0.82.0
prom-stack      monitoring      4               2025-05-02 22:57:31.821629 +0900 KST    deployed        kube-prometheus-stack-71.1.0    v0.82.0
prom-stack      monitoring      7               2025-05-03 20:53:20.274697 +0900 KST    deployed        kube-prometheus-stack-71.1.0    v0.82.0



# ì‚­ì œì‹œ...
$ helm -n monitoring delete prom-stack



```



#### ì£¼ìš” ì„¤ì • í•­ëª© ì„¤ëª…

| **í•­ëª©**                 | **ì„¤ëª…**                                         |
| ------------------------ | ------------------------------------------------ |
| grafana.ingress.*        | Grafanaì— ëŒ€í•œ Ingress ì„¤ì •                      |
| grafana.persistence.*    | PVCë¥¼ ì´ìš©í•œ Grafana ë°ì´í„° ìœ ì§€                 |
| prometheus.ingress.*     | Prometheus Web UI ì ‘ê·¼ Ingress                   |
| prometheus.persistence.* | Prometheus ì¥ê¸° ë°ì´í„° ì €ì¥ì„ ìœ„í•œ ì„¤ì •          |
| alertmanager.ingress.*   | Alertmanager Web UI ì ‘ê·¼ ì„¤ì •                    |
| alertmanager.config      | Mattermostì™€ ì—°ë™ëœ Webhook ê¸°ë°˜ Alert ìˆ˜ì‹  ì„¤ì • |



#### ì„¤ì¹˜ëœ values í™•ì¸

```sh


# values í™•ì¸
$ helm -n monitoring get values prom-stack
USER-SUPPLIED VALUES:
alertmanager:
  enabled: true
  ingress:
    annotations:
      cert-manager.io/cluster-issuer: letsencrypt-prod
      nginx.ingress.kubernetes.io/ssl-redirect: "true"
    enabled: true
    hosts:
    - alertmanager.cbiz.kubepia.net
    ingressClassName: nginx
    tls:
    - hosts:
      - alertmanager.cbiz.kubepia.net
      secretName: alertmanager-tls
  persistence:
    enabled: true
    size: 10Gi
grafana:
  enabled: true
  ingress:
    annotations:
      cert-manager.io/cluster-issuer: letsencrypt-prod
      nginx.ingress.kubernetes.io/ssl-redirect: "true"
    enabled: true
    hosts:
    - grafana.cbiz.kubepia.net
    ingressClassName: nginx
    tls:
    - hosts:
      - grafana.cbiz.kubepia.net
      secretName: grafana-tls
  persistence:
    enabled: true
    size: 10Gi
prometheus:
  ingress:
    annotations:
      cert-manager.io/cluster-issuer: letsencrypt-prod
      nginx.ingress.kubernetes.io/ssl-redirect: "true"
    enabled: true
    hosts:
    - prometheus.cbiz.kubepia.net
    ingressClassName: nginx
    tls:
    - hosts:
      - prometheus.cbiz.kubepia.net
      secretName: prometheus-tls
  persistence:
    enabled: true
    size: 20Gi




```











#### ì„¤ì¹˜ í™•ì¸

```sh

$ kubectl get all -n monitoring
NAME                                                      READY   STATUS    RESTARTS   AGE
pod/prom-stack-grafana-bcf8d9bf6-flsc2                    3/3     Running   0          28m
pod/prom-stack-kube-prometheus-operator-7f44849fb-plnz7   1/1     Running   0          28m
pod/prom-stack-kube-state-metrics-56c4668688-2vqv4        1/1     Running   0          28m
pod/prom-stack-prometheus-node-exporter-df2zf             1/1     Running   0          28m
pod/prom-stack-prometheus-node-exporter-hnnrl             1/1     Running   0          28m
pod/prometheus-prom-stack-kube-prometheus-prometheus-0    2/2     Running   0          28m

NAME                                              TYPE        CLUSTER-IP        EXTERNAL-IP   PORT(S)             AGE
service/prom-stack-grafana                        ClusterIP   192.168.126.114   <none>        80/TCP              28m
service/prom-stack-kube-prometheus-alertmanager   ClusterIP   192.168.126.235   <none>        9093/TCP,8080/TCP   28m
service/prom-stack-kube-prometheus-operator       ClusterIP   192.168.126.75    <none>        443/TCP             28m
service/prom-stack-kube-prometheus-prometheus     ClusterIP   192.168.126.118   <none>        9090/TCP,8080/TCP   28m
service/prom-stack-kube-state-metrics             ClusterIP   192.168.126.151   <none>        8080/TCP            28m
service/prom-stack-prometheus-node-exporter       ClusterIP   192.168.126.79    <none>        9100/TCP            28m
service/prometheus-operated                       ClusterIP   None              <none>        9090/TCP            28m

NAME                                                 DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR            AGE
daemonset.apps/prom-stack-prometheus-node-exporter   2         2         2       2            2           kubernetes.io/os=linux   28m

NAME                                                  READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/prom-stack-grafana                    1/1     1            1           28m
deployment.apps/prom-stack-kube-prometheus-operator   1/1     1            1           28m
deployment.apps/prom-stack-kube-state-metrics         1/1     1            1           28m

NAME                                                            DESIRED   CURRENT   READY   AGE
replicaset.apps/prom-stack-grafana-bcf8d9bf6                    1         1         1       28m
replicaset.apps/prom-stack-kube-prometheus-operator-7f44849fb   1         1         1       28m
replicaset.apps/prom-stack-kube-state-metrics-56c4668688        1         1         1       28m

NAME                                                                READY   AGE
statefulset.apps/prometheus-prom-stack-kube-prometheus-prometheus   1/1     28m



$ kubectl get ingress -n monitoring
NAME                                      CLASS   HOSTS                           ADDRESS         PORTS     AGE
prom-stack-grafana                        nginx   grafana.cbiz.kubepia.net        4.230.150.113   80, 443   28m
prom-stack-kube-prometheus-alertmanager   nginx   alertmanager.cbiz.kubepia.net   4.230.150.113   80, 443   28m
prom-stack-kube-prometheus-prometheus     nginx   prometheus.cbiz.kubepia.net     4.230.150.113   80, 443   28m


```



#### alertmanager í™•ì¸

```sh
$ kubectl -n monitoring get pods -l app.kubernetes.io/name=alertmanager
$ kubectl -n monitoring get svc -l app.kubernetes.io/name=alertmanager



$ kubectl -n monitoring get alertmanager
NAME                                      VERSION   REPLICAS   READY   RECONCILED   AVAILABLE   AGE
prom-stack-kube-prometheus-alertmanager   v0.28.1   1          1       True         True        17h

$ kubectl -n monitoring get alertmanager prom-stack-kube-prometheus-alertmanager -o yaml
apiVersion: monitoring.coreos.com/v1
kind: Alertmanager
metadata:
  annotations:
    meta.helm.sh/release-name: prom-stack
    meta.helm.sh/release-namespace: monitoring
  creationTimestamp: "2025-05-02T13:40:00Z"
  generation: 1
  labels:
    app: kube-prometheus-stack-alertmanager
    app.kubernetes.io/instance: prom-stack
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/part-of: kube-prometheus-stack
    app.kubernetes.io/version: 71.1.0
    chart: kube-prometheus-stack-71.1.0
    heritage: Helm
    release: prom-stack
  name: prom-stack-kube-prometheus-alertmanager
  namespace: monitoring
  resourceVersion: "2985133"
  uid: 3920384f-d636-4f12-a16f-7afe0bad0bf3
spec:
  affinity:
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
      - podAffinityTerm:
          labelSelector:
            matchExpressions:
            - key: app.kubernetes.io/name
              operator: In
              values:
              - alertmanager
            - key: alertmanager
              operator: In
              values:
              - prom-stack-kube-prometheus-alertmanager
          topologyKey: kubernetes.io/hostname
        weight: 100
  alertmanagerConfigNamespaceSelector: {}
  alertmanagerConfigSelector: {}
  automountServiceAccountToken: true
  externalUrl: http://alertmanager.cbiz.kubepia.net/
  image: quay.io/prometheus/alertmanager:v0.28.1
  listenLocal: false
  logFormat: logfmt
  logLevel: info
  paused: false
  portName: http-web
  replicas: 1
  retention: 120h
  routePrefix: /
  securityContext:
    fsGroup: 2000
    runAsGroup: 2000
    runAsNonRoot: true
    runAsUser: 1000
    seccompProfile:
      type: RuntimeDefault
  serviceAccountName: prom-stack-kube-prometheus-alertmanager
  version: v0.28.1
status:
  availableReplicas: 1
  conditions:
  - lastTransitionTime: "2025-05-02T13:48:28Z"
    message: ""
    observedGeneration: 1
    reason: ""
    status: "True"
    type: Available
  - lastTransitionTime: "2025-05-02T13:48:13Z"
    message: ""
    observedGeneration: 1
    reason: ""
    status: "True"
    type: Reconciled
  paused: false
  replicas: 1
  selector: alertmanager=prom-stack-kube-prometheus-alertmanager,app.kubernetes.io/instance=prom-stack-kube-prometheus-alertmanager,app.kubernetes.io/managed-by=prometheus-operator,app.kubernetes.io/name=alertmanager
  unavailableReplicas: 0
  updatedReplicas: 1
  


# spec.config ì´ ì¡´ì¬í•´ì•¼ í•¨.


```







## 3) Grafana ì ‘ê·¼ ì •ë³´

â€‹	â€¢	ê¸°ë³¸ ì‚¬ìš©ì: admin

â€‹	â€¢	ì´ˆê¸° ë¹„ë°€ë²ˆí˜¸:

```sh
$ kubectl --namespace monitoring get secrets prom-stack-grafana -o jsonpath="{.data.admin-password}" | base64 -d ; echo

prom-operator

```



```sh

https://grafana.cbiz.kubepia.net

https://prometheus.cbiz.kubepia.net

https://alertmanager.cbiz.kubepia.net
  
```







## **ğŸ“ Alert Rule ì˜ˆì‹œ**



> ì•„ë˜ íŒŒì¼ì„ ConfigMapìœ¼ë¡œ ìƒì„± í›„ Prometheusì— mount í•˜ê±°ë‚˜ Helm valuesë¡œ ì „ë‹¬

```
groups:
  - name: ap.rules
    rules:
      - alert: HighCpuUsage
        expr: sum(rate(container_cpu_usage_seconds_total{namespace="ap"}[1m])) by (pod) > 0.8
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: "High CPU usage detected"
          description: "{{ $labels.pod }} has CPU usage > 80%."
```







## 2) Alertmanager ë©”ì‹œì§€ í¬ë§· ì»¤ìŠ¤í„°ë§ˆì´ì§•



AlertmanagerëŠ” ë©”ì‹œì§€ë¥¼ JSON í˜•íƒœë¡œ Webhookì— ì „ë‹¬í•˜ë©°, template íŒŒì¼ì„ í†µí•´ ì»¤ìŠ¤í„°ë§ˆì´ì§• ê°€ëŠ¥í•©ë‹ˆë‹¤.



**ğŸ”§ Alertmanager values.yaml ë˜ëŠ” --set ì„¤ì • ì˜ˆì‹œ**



> Helm ì„¤ì¹˜ ì‹œ alertmanager.templateFiles í‚¤ë¥¼ ì‚¬ìš©í•˜ì—¬ í…œí”Œë¦¿ ì§€ì • ê°€ëŠ¥

```
alertmanager:
  templateFiles:
    mattermost_template.tmpl: |
      {{ define "mattermost.default.message" }}
      :rotating_light: **[{{ .Status | toUpper }}] Alert** :rotating_light:
      **Alert:** {{ .CommonAnnotations.summary }}
      **Description:** {{ .CommonAnnotations.description }}
      **Affected Pods:** {{ range .Alerts }} - `{{ .Labels.pod }}`{{ end }}
      **Severity:** {{ .CommonLabels.severity }}
      {{ end }}
```

ìœ„ í…œí”Œë¦¿ì€ ë‹¤ìŒ ë©”ì‹œì§€ í˜•ì‹ìœ¼ë¡œ ì „ì†¡ë©ë‹ˆë‹¤:

```
:rotating_light: **[FIRING] Alert** :rotating_light:
**Alert:** High CPU usage detected
**Description:** ap-pod-1 has CPU > 90% for 1m
**Affected Pods:**
 - `ap-pod-1`
 - `ap-pod-2`
**Severity:** warning
```

**ğŸ”‘ ê´€ë ¨ í•„ë“œ ì„¤ëª…**

| **ë³€ìˆ˜**                       | **ì„¤ëª…**                              |
| ------------------------------ | ------------------------------------- |
| .Status                        | firing ë˜ëŠ” resolved                  |
| .CommonAnnotations.summary     | ì•Œë¦¼ ì œëª©                             |
| .CommonAnnotations.description | ìƒì„¸ ì„¤ëª…                             |
| .Alerts                        | ë°œìƒí•œ Alert ëª©ë¡ (ì—¬ëŸ¬ ê°œì¼ ìˆ˜ ìˆìŒ) |
| .CommonLabels.severity         | ì•Œë¦¼ ì‹¬ê°ë„ (warning, critical ë“±)    |





**ğŸ“¥ Helm ì„¤ì¹˜ ì‹œ --set ì˜ˆì‹œ**

```
--set alertmanager.templateFiles.mattermost_template.tmpl="$(< mattermost_template.tmpl)"

```

> ë˜ëŠ” values.yamlì— ì§ì ‘ ë„£ê³  -f values.yamlë¡œ ì„¤ì¹˜





**âœ… í…ŒìŠ¤íŠ¸ í…œí”Œë¦¿ ì ìš© í™•ì¸ ë°©ë²•**

```
kubectl -n monitoring delete pod -l app.kubernetes.io/name=alertmanager

```

Pod ì¬ì‹œì‘ í›„ í…œí”Œë¦¿ì´ ì ìš©ëœ ìƒíƒœë¡œ Alertì´ ì „ì†¡ë©ë‹ˆë‹¤.



